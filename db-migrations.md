데이터베이스 마이그레이션
============================

> Note |주의 :이 절은 아직 작성 중입니다.

소스 코드와 같이 데이터베이스의 구조도 데이터베이스 기반의 응용 프로그램이 개발되고 유지 보수됨에 따라 점차 발전하고 있습니다.
예를 들어, 개발 중에 새로 테이블이 추가 될 수도있을 것이고, 응용 프로그램을 실서비스 한후 성능 개선을 위해 인덱스를 추가해야 할수도 있습니다.
이러한 데이터베이스의 구조적인 변경 (** 마이그레이션 **라고합니다)은 종종 약간의 소스코드 변경이 필요 합니다.
이러한 이유로 인해 Yii는 버전 제어 소스 코드와 함께 데이터베이스 마이그레이션의 관점에서 데이터베이스 변경을 추적 할 수있는 이른바 데이터베이스 마이그레이션 기능을 지원합니다.

다음 단계는 개발 중에 팀에 의해 데이터베이스 마이그레이션이 사용되는 예를 보여줍니다.

1. Tim이 새로운 마이그레이션을 만든다.(예를 들어, 새 테이블을 만들거나 열 정의를 변경 하는 등등)
2. Tim이 새로운 마이그레이션을 소스 컨트롤 시스템 에 등록한다. (예를 들어 Git이나 Mercurial)
3. Doug이 소스 컨트롤 시스템에서 자신의 저장소를 업데이트하여 새 마이그레이션을 받는다.
4. Doug이 자신의 로컬 개발 데이터베이스에 적용하고 Tim이 변경 사항을 반영하여 자신의 데이터베이스를 동기화한다.

그리고 다음 단계는 데이터베이스 마이그레이션과 새로운 릴리스를 배포하는 방법을 보여줍니다

1.Scott은 몇 가지 새로운 데이터베이스 마이그레이션을 포함한 프로젝트 저장소에 릴리스 태그를 만듭니다.
2.Scott은 자료 태그 프로덕션 서버의 소스 코드를 업데이트합니다.
3.Scott은 프로덕션 데이터베이스에 쌓인의 데이터베이스 마이그레이션을 적용합니다.

Yii는 데이터베이스 마이그레이션을 명령 줄 도구에서 다음과 같은 기능을 지원합니다.

* 새로운 마이그레이션을 만들기
* 마이그레이션 적용;
* 마이그레이션 복원;
* 마이그레이션 다시 적용;
* 마이그레이션 히스토리와 상태를 표시.

이러한 모든 명령은 Yii 마이그레이션을 통해 엑세스 할수 있습니다.이 섹션에서 우리는 이러한 기능를 사용하여 다양한 작업을 수행하는 방법을 자세히 설명합니다. 또한 help 명령과 yii 도움말 전환을 통해 각 기능의 사용 방법을 받을수 있습니다.

> Tip |힌트 : 마이그레이션뿐만 아니라 데이터베이스 스키마에 영향을 주지만 새로운 스키마에 맞춰 RBAC의 hierarcy을 만들거나 캐시를 정리하기 위해 기존 데이터를 조정할 수 있습니다.


마이그레이션 만들기
--------------------------

새로운 마이그레이션을 작성하기 위해서는 다음 명령을 실행합니다.

```
yii migrate/create <name>
```

`name` 인수는 새 마이그레이션을 만드는 방법에 대한 간략한 설명을 지정합니다. 예를 들어, 당신은 이름 create_news_table을 사용하여 다음 명령을 실행 할 수 있습니다.

```
yii migrate/create create_news_table
```

> Note | 주의: name 인수는 생성 된 마이그레이션 클래스 이름의 일부로 사용되기 때문에, 알파벳, 숫자 및 / 또는 밑줄 만 포함해야합니다.


위의 명령은`m101129_185401_create_news_table.php`라는 새 파일을 만듭니다.
이 파일은`@app/migrations` 디렉토리에 생성됩니다.
초기 상태에서의 `m101129_185401_create_news_table` 마이그레이션 파일은 다음의 코드를 포함하고 있습니다.

```php
<?php

use yii\db\Migration;

class m150101_185401_create_news_table extends Migration
{
    public function up()
    {

    }

    public function down()
    {
        echo "m101129_185401_create_news_table cannot be reverted.\n";

        return false;
    }

    /*
    // Use safeUp/safeDown to run migration code within a transaction
    public function safeUp()
    {
    }

    public function safeDown()
    {
    }
    */
}
```

클래스 이름은 파일 이름과 동일하며`m<YYMMDD_HHMMSS>_<Name>`패턴을 따릅니다. 여기에서

* '<YYMMDD_HHMMSS>` 마이그레이션 작성 명령이 실행되는 UTC의 날짜를 의미한다.
*`<name>`명령에 제공`NAME` 인수의 값과 동일합니다.

클래스 중에서는`up()`메소드가 실제 데이터베이스 마이그레이션을 구현하는 코드를 포함 할 메소드입니다.
즉,`up()`메소드가 실제로 데이터베이스를 변경하는 코드를 실행합니다.
`down()`메쏘드는`up()`에 의해 변경된 내용을 취소하는 코드를 포함 할 수 있습니다.

다음 코드는`news` 테이블을 만들 수있는 마이그레이션 클래스를 구현할 수 방법을 보여줍니다

```php
<?php

use yii\db\Schema;
use yii\db\Migration;

class m150101_185401_create_news_table extends Migration
{
    public function up()
    {
        $this->createTable('news', [
            'id' => Schema::TYPE_PK,
            'title' => Schema::TYPE_STRING . ' NOT NULL',
            'content' => Schema::TYPE_TEXT,
        ]);
    }

    public function down()
    {
        $this->dropTable('news');
    }
}
```



base class 인 [[\ yii \ db \ Migration]]가 데이터베이스 연결을`db` 속성에 의해 제공됩니다.
이를 사용하여 데이터베이스의 데이터와 스키마를 조작 할 수 있습니다.

이 예에서 사용되는 컬럼의 타입은 추상 유형이며, Yii하여 당신이 사용하는 데이터베이스 관리 시스템에 따라 해당 유형으로 대체합니다.
추상 유형을 사용하면 데이터베이스에 의존하지 않는 마이그레이션을 쓸 수 있습니다.
예를 들어,`pk`는 MySQL에서`int (11) NOT NULL AUTO_INCREMENT PRIMARY KEY`로 대체 sqlite는`integer PRIMARY KEY AUTOINCREMENT NOT NULL`로 대체합니다.
더 자세한 설명과 사용 가능한 유형은 [yii \ db \ QueryBuilder :: getColumnType ()]]의 문서를 참조하십시오.
또한 컬럼의 타입을 정의하는데 [yii \ db \ Schema]에서 정의 된 상수를 사용할 수도 있습니다.

> Note |주의 : 테이블 정의의 마지막에 간단한 문자열로 지정된 제약 및 기타 특별한 테이블 옵션을 추가 할 수 있습니다.
> 예를 들어, 위의 이주는`content` 속성의 정의 후,` 'CONSTRAINT ...'`나 기타 특별한 옵션을 쓸 수 있습니다.


트랜잭션을 사용 마이그레이션
--------------------------------------

복잡한 DB 마이그레이션을 수행 할 때는 일반적으로 데이터베이스의 일관성과 무결성을 유지하기 위해 개별 마이그레이션이 전체적으로 성공 또는 실패하는 것을 보장해야합니다.
이 목적을 달성하기 위해 DB 트랜잭션을 이용할 수 있습니다.
이를 위해서는`safeUp`와`safeDown`라는 특별한 메소드를 사용합니다.

```php

use yii \ db \ Schema;

class m101129_185401_create_news_table extends \ yii \ db \ Migration
{
    public function safeUp ()
    {
        $ this-> createTable ( 'news',
            'id'=> 'pk'
            'title'=> Schema : TYPE_STRING 'NOT NULL'
            'content'=> Schema : TYPE_TEXT,
        ]);

        $ this-> createTable ( 'user',
            'id'=> 'pk'
            'login'=> Schema : TYPE_STRING 'NOT NULL'
            'password'=> Schema : TYPE_STRING 'NOT NULL'
        ]);
    }

    public function safeDown ()
    {
        $ this-> dropTable ( 'news');
        $ this-> dropTable ( 'user');
    }

}
```

사용하는 쿼리가 하나뿐 않으면`safeUp`와`safeDown`를 사용할 것을 권장합니다.

> Note |주의 : 모든 DBMS가 트랜잭션을 지원하고있는 것은 아닙니다.
> 또한 트랜잭션에 넣을 수없는 DB 쿼리 수 있습니다.
> 그 경우에는 대신에,`up ()`와`down ()`를 구현해야합니다.
> 또한 MySQL의 경우 암시 적 커밋 (http://dev.mysql.com/doc/refman/5.1/en/implicit-commit.html)를 일으키는 SQL 문장이 있습니다.


마이그레이션을 적용
--------------------------

사용 가능한 모든 새로운 마이그레이션을 적용 (즉, 로컬 데이터베이스를 최신 상태로)하는 다음 명령을 실행합니다.

```
yii migrate
```

명령을 실행하면 모든 새로운 마이그레이션이 나열됩니다.
마이그레이션을 적용하는 것을 확인하면 클래스 이름의 타임 스탬프 값의 순서대로 하나씩 모든 새로운 마이그레이션 클래스의`up ()`메소드가 실행됩니다.

마이그레이션을 적용한 후 이주 도구는`migration`라는 데이터베이스 테이블에 기록을 남깁니다.
따라서 도구는 어떤 마이그레이션이 적용된에서 어떤 마이그레이션이 적용되지 않았는지 확인할 수 있습니다.
`migration` 테이블이 존재하지 않는 경우 도구는`db` 응용 프로그램 구성 요소 (structure-application-components.md)에 의해 지정된 데이터베이스에 테이블을 자동으로 작성합니다.

어떠한 경우에는, 새로운 마이그레이션을 한 개 또는 몇 개만 적용 할 수 있습니다. 이 경우 다음 명령을 사용할 수 있습니다.


```
yii migrate / up 3
```

이 명령은 다음의 새로운 마이그레이션을 3 개 적용합니다. 3이라는 값을 변경하여 적용되는 이주 수를 변경할 수 있습니다.

또한 다음 명령을 사용하여 특정 버전까지 데이터베이스를 마이그레이션 할 수 있습니다.

```
yii migrate / to 101129_185401
```

즉 마이그레이션 이름의 타임 스탬프 부분을 사용하여 데이터베이스를 마이그레이션하고 도달하고자 버전을 지정합니다.
마지막으로 적용된 마이그레이션 및 지정된 마이그레이션 사이에 여러 마이그레이션이있는 경우는 그 마이그레이션이 적용됩니다.
지정된 마이그레이션이 적용되어있는 경우는 다음에 적용된 모든 마이그레이션이 취소됩니다 (다음 절에서 설명합니다).


마이그레이션을 취소
--------------------------

적용된 마지막 마이그레이션 (한 개 또는 복수)을 취소하려면 다음 명령을 사용할 수 있습니다.


```
yii migrate / down [step]
```

여기서 옵션`step` 매개 변수는 몇개의 마이그레이션을 취소 여부를 지정하는 것입니다.
기본값은 1에서 적용된 마지막 마이그레이션 만 삭제되는 것을 의미합니다.

앞에서 설명한 바와 같이, 모든 이주를 취소 할 수는 없습니다.
취소 않은 마이그레이션을 취소하려고하면 예외가 던져 취소의 전 과정이 종료됩니다.


마이그레이션을 다시 적용
----------------------------

마이그레이션을 다시 적용은 지정된 마이그레이션을 먼저 취소하고 다시 적용하는 것을 의미합니다.
이것은 다음의 명령으로 수행 할 수 있습니다.

```
yii migrate / redo [step]
```

여기서 옵션`step` 매개 변수는 몇개의 이주를 다시 적용할지 여부를 지정합니다.
기본값은 1에서 마지막 마이그레이션 만 다시 적용되는 것을 의미합니다.


마이그레이션 정보를 표시하는
------------------------------

마이그레이션을 적용하거나 취소하는 다른 이주 도구는 이주의 역사, 그리고 아직 적용되지 않은 새 마이그레이션을 볼 수 있습니다.


```
yii migrate / history [limit]
yii migrate / new [limit]
```

여기서 옵션`limit` 매개 변수는 몇개의 마이그레이션을 표시할지 여부를 지정합니다.
`limit`가 지정되지 않으면 사용 가능한 모든 이주가 표시됩니다.

첫 번째 명령은 적용된 마이그레이션을 표시하고 두 번째 명령은 아직 적용되지 않은 마이그레이션을 표시합니다.


마이그레이션 내역을 수정
------------------------------

어떠한 경우에는, 실제로 관계있는 마이그레이션을 적용하거나 취소하지 않고 마이그레이션 내역을 특정 마이그레이션 버전으로 수정할 수 있습니다.
이것은 새로운 마이그레이션을 개발할 때 자주 발생합니다.
다음 명령을 사용하여이 목적을 달성 할 수 있습니다.

```
yii migrate / mark 101129_185401
```

이 명령은`yii migrate / to` 명령과 매우 비슷하지만 마이그레이션을 적용하거나 취소하지 않고 마이그레이션 기록 테이블을 지정된 버전으로 수정하는 것만을한다는 점에서 차이가 있습니다.


마이그레이션 명령을 사용자 정의 할
------------------------------------------

마이그레이션 명령을 사용자 지정하는 방법이 몇 가지 있습니다.

### 명령 줄 옵션을 사용

마이그레이션 명령은 명령 줄에서 지정할 수있는 몇 가지 옵션이 있습니다.

*`interactive` : 부울. 마이그레이션을 대화식 모드로 실행할지 여부를 지정합니다.
  기본값은 true로 지정된 마이그레이션을 수행 할 때 사용자는 어떠한 입력하라는 메시지가 표시됩니다.
  이 옵션을 false로 설정하여 마이그레이션이 백그라운드 프로세스로 실행되도록 할 수 있습니다.

*`migrationPath` : 문자열. 모든 마이그레이션 클래스 파일을 저장하고있는 디렉토리를 지정합니다.
  이 경로는 경로 별칭 형식으로 지정되어야하며, 또한 해당 디렉토리가 존재해야합니다.
  이 옵션이 지정되지 않은 경우 응용 프로그램의 기본 경로 아래의`migrations` 하위 디렉토리가 사용됩니다.

*`migrationTable` : 문자열. 마이그레이션 이력 정보를 저장하는 데이터베이스 테이블 이름을 지정합니다.
  기본값은`migration`입니다. 이 테이블은`version varchar (255) primary key, apply_time integer`라는 구조를 가지고 있습니다.

*`db` : 문자열. 데이터베이스 응용 프로그램 구성 요소 (structure-application-components.md)의 ID를 지정합니다.
  기본값은 'db'입니다.

*`templateFile` : 문자열. 마이그레이션 클래스를 생성하기위한 코드 템플릿으로 사용되는 파일의 경로를 지정합니다.
  이 경로는 경로 별칭 형식으로 지정해야합니다 (예를 들어,`application.migrations.template`).
  지정되지 않은 경우, 내부 템플릿이 사용됩니다.
  템플릿 중`{ClassName}`이라는 토큰이 실제 마이그레이션 클래스 이름으로 대체됩니다.

이 옵션을 지정하기 위해서는 아래의 서식을 사용하여 migrate 명령을 실행합니다.

```
yii migrate / up --option1 = value1 --option2 = value2 ...
```

예를 들어,`forum` 모듈에 대한 마이그레이션을 실행할 때 마이그레이션 파일이 모듈의`migrations` 디렉토리에있는 경우, 다음 명령을 사용할 수 있습니다.


```
yii migrate / up --migrationPath = @ app / modules / forum / migrations
```


### 명령을 전역으로 구성

명령 줄 옵션을 사용하여 마이그레이션 명령을 그 자리에서 구성 할 수도 있지만, 경우에 따라서는 한꺼번에 명령을 구성하고 싶은 것도 있습니다.
예를 들어, 이주의 기록을 저장하는 데 다른 테이블을 사용하고 싶거나 사용자 지정 마이그레이션 템플릿을 사용 싶다 든가입니다.
그렇게하기 위해서는 콘솔 응용 프로그램의 구성 정보 파일을 다음과 같이 수정합니다.


```php
'controllerMap'=>
    'migrate'=>
        'class'=> 'yii \ console \ controllers \ MigrateController'
        'migrationTable'=> 'my_custom_migrate_table'
    ,
]
```

이제`migrate` 명령을 실행하면 위의 구성 정보가 효과를 발휘하고 매번 명령 줄 옵션을 입력 할 필요가 없습니다.
기타 명령 행 옵션이 같이 구성 할 수 있습니다.


### 여러 데이터베이스 이주

기본적으로 이주는`db` 응용 프로그램 구성 요소 (structure-application-components.md)에 의해 지정되는 데이터베이스에 적용됩니다.
그것은`--db` 옵션을 지정하여 변경할 수 있습니다. 예를 들어,

```
yii migrate --db = db2
```

위의 명령은 기본 마이그레이션 경로에있는 * 모든 * 마이그레이션을`db2` 데이터베이스에 적용하는 것입니다.

응용 프로그램이 여러 데이터베이스를 처리하는 경우는 일부 마이그레이션은 데이터베이스에 적용되어야하며, 다른 마이그레이션은 다른 데이터베이스에 적용되어야한다는 것이있을 수 있습니다.
그런 경우에는 다른 데이터베이스에 대해 기본 마이그레이션 클래스를 작성하여 아래와 같이 [yii \ db \ Migration :: init ()] 메소드를 오버라이드 (override) 할 것을 권장합니다.

```php
public function init ()
{
    $ this-> db = 'db2';
    parent :: init ();
}
```

이렇게하면 특정 데이터베이스에 적용되어야 마이그레이션을 작성하기 위해서는 해당 기초 마이그레이션 클래스에서 확장하는 것만으로 끝납니다.
이제`yii migrate` 명령을 실행하면 모든 이주 해당 데이터베이스에 적용되게됩니다.

> Info | 정보 : 각각의 마이그레이션은 하드 코드 된 DB 연결을 사용하기 때문에`migrate` 명령의`--db` 옵션은 효과가 없습니다.
  또한 마이그레이션 내역은 기본`db` 데이터베이스에 저장되는 것에주의하십시오.

`--db` 옵션으로 DB 연결의 변경을 지원하려면 다음과 같은 다른 방법으로 여러 데이터베이스를 처리 할 수?? 있습니다.

각 데이터베이스의 이주 경로를 생성하고 해당 모든 마이그레이션 클래스를 거기에 저장합니다.
마이그레이션을 적용하기 위해서는 다음과 같은 명령을 실행합니다.

```
yii migrate --migrationPath = @ app / migrations / db1 --db = db1
yii migrate --migrationPath = @ app / migrations / db2 --db = db2
...
```

> Info | 정보 : 위의 방법으로 이주 역사는`--db` 옵션에 의해 지정된 별도의 데이터베이스에 저장됩니다.